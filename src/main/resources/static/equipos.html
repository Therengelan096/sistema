<!DOCTYPE html>
<html lang="en" class="h-100 text-bg-dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gestión de Equipos</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.min.css">
  <style>
    /* Estilos existentes para el cuerpo, sidebar y contenido */
    body {
      display: flex;
      min-height: 100vh;
      margin: 0;
      padding: 0;
      background-color: #121212;
      color: white;
    }

    .sidebar {
      width: 280px;
      background-color: #191970;
      padding-top: 20px;
      display: flex;
      flex-direction: column;
      height: 100vh;
      position: fixed;
      top: 0;
      left: 0;
      transition: width 0.3s ease;
      overflow: hidden;
      z-index: 1000; /* Asegura que esté por encima del contenido */
    }

    .sidebar.collapsed {
      width: 60px;
    }

    .sidebar a {
      padding: 12px 15px;
      color: white;
      text-decoration: none;
      transition: background-color 0.3s ease;
      border-left: 5px solid transparent;
      font-size: 0.9rem;
      display: flex;
      align-items: center;
      white-space: nowrap;
    }

    .sidebar a:hover,
    .sidebar a.active {
      background-color: #34495E;
      border-left-color: #ff69b4;
    }

    .sidebar a i {
      font-size: 1.2rem;
    }

    .sidebar a span {
      margin-left: 10px;
      white-space: nowrap;
      overflow: hidden;
      transition: opacity 0.2s ease, width 0.2s ease, margin 0.2s ease;
    }

    .sidebar.collapsed a span {
      opacity: 0;
      width: 0;
      margin: 0;
      pointer-events: none;
    }

    .sidebar.collapsed a {
      justify-content: center;
    }

    .sidebar hr {
      border-color: #34495E;
      margin: 5px 0;
    }

    .sidebar .logout-btn {
      margin-top: auto;
      border-top: 1px solid #34495E;
    }

    .toggle-btn {
      background: none;
      border: none;
      color: white;
      font-size: 1.5rem;
      cursor: pointer;
      z-index: 1000;
    }

    /* === CONTENIDO PRINCIPAL === */
    .content {
      flex-grow: 1;
      padding: 20px;
      background-color: #283747;
      position: relative;
      margin-left: 280px; /* Espacio para el sidebar */
      transition: margin-left 0.3s ease;
      min-height: 100vh; /* Asegura que ocupe al menos toda la altura */
    }

    .content.sidebar-collapsed {
      margin-left: 60px;
    }

    .form-container {
      width: 95%;
      max-width: 800px;
      margin: 20px auto 30px auto;
      background-color: #1e2a38;
      padding: 25px;
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
      text-align: left;
    }

    .form-group label {
      margin-bottom: 5px;
      display: block;
      color: #ccc;
    }

    h1, h4 {
      color: #ff69b4;
      text-shadow: 0 4px 8px rgba(255, 105, 180, 0.8);
      margin-bottom: 20px;
      text-align: center;
    }
    h4 {
      text-shadow: none;
      color: #ccc;
    }

    /* === TABLA === */
    .table-container {
      width: 95%;
      max-width: 1000px;
      margin: 20px auto;
      overflow-x: auto;
    }

    table {
      width: 100%;
      background-color: #1e2a38;
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
      border-collapse: separate;
      border-spacing: 0;
      overflow: hidden;
    }

    th, td {
      border-bottom: 1px solid #34495E;
      padding: 12px 15px;
      text-align: left;
      vertical-align: middle;
    }
    td {
      color: #e0e0e0;
    }

    th {
      background-color: #34495E;
      color: #ff69b4;
      font-weight: 600;
    }

    tr:last-child td {
      border-bottom: none;
    }

    tr:hover {
      background-color: #2c3e50;
    }

    /* === BOTÓN PERSONALIZADO === */
    .btn-pink {
      background-color: #ff69b4;
      border: none;
      color: white;
      padding: 10px 15px;
      border-radius: 5px;
      cursor: pointer;
      transition: opacity 0.2s ease;
    }

    .btn-pink:hover {
      opacity: 0.9;
    }

    .btn-sm {
      padding: 0.25rem 0.5rem;
      font-size: 0.8rem;
    }

    /* Estilos para ocultar/mostrar secciones */
    .hidden {
      display: none;
    }

  </style>
</head>

<body>

<div class="sidebar" id="sidebar">
  <a href="#" id="toggleSidebar"><i class="bi bi-list"></i><span>Menú</span></a>
  <hr>
  <a href="/laboratorios.html"><i class="bi bi-house-door"></i><span>Laboratorios</span></a>
  <hr>
  <a href="/usuarios.html"><i class="bi bi-people"></i><span>Usuarios</span></a>
  <hr>
  <a href="/mantenimiento.html"><i class="bi bi-tools"></i><span>Mantenimiento</span></a>
  <hr>
  <a href="/reportes.html"><i class="bi bi-file-earmark-bar-graph"></i><span>Reportes</span></a>
  <hr>
  <a href="/equipos.html"><i class="bi bi-pc-display-horizontal"></i><span>Equipos</span></a> <hr>
  <a href="/prestamos.html"><i class="bi bi-arrow-left-right"></i><span>Préstamos</span></a>
  <hr>
  <a href="/devolucion.html"><i class="bi bi-arrow-return-left"></i><span>Devoluciones</span></a>
  <hr>
  <a href="/sanciones.html"><i class="bi bi-exclamation-triangle"></i><span>Sanciones</span></a>
  <hr>
  <a href="/administradores.html"><i class="bi bi-person-gear"></i><span>Administradores</span></a>
  <hr>
  <a href="/categorias_equipos.html"><i class="bi bi-tags"></i><span>Categoría de Equipos</span></a>
  <a href="/logout" class="logout-btn">
    <i class="bi bi-power"></i><span>Cerrar Sesión</span>
  </a>
</div>

<div class="content" id="content">

  <h1>Gestión de Equipos</h1>

  <div class="form-container" id="tipo-equipo-form-container">
    <h4>Formulario de Tipo de Equipo</h4>
    <form id="equipo-form">
      <input type="hidden" id="idEquipo">
      <div class="mb-2 form-group">
        <label for="nombre">Nombre:</label>
        <input type="text" class="form-control" id="nombre" required>
      </div>
      <div class="mb-2 form-group">
        <label for="categoriaId">Categoría:</label>
        <select class="form-select" id="categoriaId" required>
          <option value="" disabled selected>Seleccionar Categoría</option>
        </select>
      </div>
      <div class="mb-2 form-group">
        <label for="laboratorioId">Laboratorio (Principal del Tipo):</label>
        <select class="form-select" id="laboratorioId" required>
          <option value="" disabled selected>Seleccionar Laboratorio</option>
        </select>
      </div>
      <div class="mb-2 form-group">
        <label for="descripcion">Descripción:</label>
        <input type="text" class="form-control" id="descripcion" required>
      </div>
      <div class="mb-2 form-group">
        <label for="estado">Estado (General del Tipo):</label>
        <select class="form-select" id="estado" required>
          <option value="disponible">Disponible</option>
          <option value="prestado">Prestado</option>
          <option value="en mantenimiento">En Mantenimiento</option>
        </select>
      </div>
      <div class="mb-2 form-group">
        <label for="cantidad">Cantidad (Inicial de Unidades):</label>
        <input type="number" class="form-control" id="cantidad" min="1" required>
      </div>
      <div class="mb-2 form-group">
        <label for="marca">Marca:</label>
        <input type="text" class="form-control" id="marca" required>
      </div>
      <button type="submit" class="btn btn-pink mt-2">Guardar Tipo y Unidades</button>
      <button type="button" class="btn btn-secondary mt-2 hidden" id="cancel-edit-type">Cancelar Edición</button>
    </form>
  </div>

  <div class="table-container mt-4" id="tipos-equipo-table-container">
    <h4>Listado de Tipos de Equipo</h4>
    <table>
      <thead>
      <tr>
        <th>ID Tipo</th>
        <th>Nombre</th>
        <th>Categoría</th>
        <th>Laboratorio (General)</th>
        <th>Descripción</th>
        <th>Estado (General)</th>
        <th>Cantidad (General)</th>
        <th>Marca</th>
        <th>Acciones</th>
      </tr>
      </thead>
      <tbody id="equipos-body"></tbody>
    </table>
  </div>

  <div id="instancias-section" class="hidden">
    <h3 id="instancias-section-title" class="mt-5">Instancias Individuales</h3>

    <div class="table-container mt-4">
      <h4>Listado de Unidades Individuales</h4>
      <p>Tipo: <strong id="current-instance-type-name"></strong></p>
      <table>
        <thead>
        <tr>
          <th>ID Instancia</th>
          <th>Código Activo</th>
          <th>Estado Individual</th>
          <th>Fecha Adquisición</th>
        </tr>
        </thead>
        <tbody id="instancias-body">
        </tbody>
      </table>
      <button class="btn btn-secondary mt-3" id="back-to-types-btn">Volver a Tipos de Equipo</button>
    </div>
  </div>

</div> <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
  // --- Variables y Referencias del DOM ---
  const sidebar = document.getElementById('sidebar');
  const content = document.getElementById('content');
  const toggleSidebarBtn = document.getElementById('toggleSidebar');

  // Elementos del formulario de Tipo de Equipo
  const tipoEquipoFormContainer = document.getElementById('tipo-equipo-form-container');
  const equipoForm = document.getElementById('equipo-form');
  const idEquipoInput = document.getElementById('idEquipo');
  const nombreInput = document.getElementById('nombre');
  const descripcionInput = document.getElementById('descripcion');
  const estadoInput = document.getElementById('estado'); // Estado general del tipo
  const categoriaIdSelect = document.getElementById('categoriaId');
  const laboratorioIdSelect = document.getElementById('laboratorioId'); // Laboratorio general del tipo
  const cantidadInput = document.getElementById('cantidad'); // Cantidad inicial
  const marcaInput = document.getElementById('marca');
  const cancelEditTypeBtn = document.getElementById('cancel-edit-type');


  // Elementos de la Tabla de Tipos de Equipo
  const tiposEquipoTableContainer = document.getElementById('tipos-equipo-table-container');
  const equiposTbody = document.getElementById('equipos-body'); // Body de la tabla de tipos

  // === ELEMENTOS PARA LISTAR INSTANCIAS INDIVIDUALES (SIN EDICIÓN) ===
  const instanciasSection = document.getElementById('instancias-section'); // Contenedor principal de la sección de instancias
  const instanciasSectionTitle = document.getElementById('instancias-section-title'); // Título de la sección de instancias
  const currentInstanceTypeName = document.getElementById('current-instance-type-name'); // Para mostrar el nombre del tipo actual
  const instanciasTbody = document.getElementById('instancias-body'); // Body de la tabla de instancias individuales
  const backToTypesBtn = document.getElementById('back-to-types-btn'); // Botón para volver a la vista de tipos

  // --- Eliminadas referencias al formulario de edición de instancia ---


  // --- URLs del API ---
  const API_BASE_URL = 'http://localhost:8083/equipos'; // Endpoint principal para tipos
  const API_CATEGORIAS_URL = 'http://localhost:8083/categorias'; // Endpoint para categorías
  const API_LABORATORIOS_URL = 'http://localhost:8083/laboratorios'; // Endpoint para laboratorios
  const API_INSTANCIAS_URL = `${API_BASE_URL}/instancias`; // Endpoint para instancias (general)

  // --- Variables de estado ---
  let currentTipoEquipoId = null; // Variable para guardar el ID del tipo cuando vemos sus instancias

  // --- Funciones de Carga Inicial ---

  // Cargar categorías para el select en el formulario de tipo
  function cargarCategorias() {
    fetch(API_CATEGORIAS_URL)
            .then(res => res.json())
            .then(data => {
              categoriaIdSelect.innerHTML = '<option value="" disabled selected>Seleccionar Categoría</option>'; // Limpiar antes de cargar
              data.forEach(categoria => {
                const option = document.createElement('option');
                // Usar los nombres de propiedad que vienen del backend (deben coincidir con los nombres de columna DB)
                option.value = categoria.idCategoria;
                option.textContent = categoria.nombreCategoria;
                categoriaIdSelect.appendChild(option);
              });
            })
            .catch(err => console.error('Error al cargar categorías:', err));
  }

  // Cargar laboratorios para el select en el formulario de tipo
  function cargarLaboratorios() {
    fetch(API_LABORATORIOS_URL)
            .then(res => res.json())
            .then(data => {
              laboratorioIdSelect.innerHTML = '<option value="" disabled selected>Seleccionar Laboratorio</option>'; // Limpiar antes de cargar
              data.forEach(laboratorio => {
                const option = document.createElement('option');
                // Usar los nombres de propiedad que vienen del backend
                option.value = laboratorio.idLaboratorio; // Asumiendo idLaboratorio en JSON
                option.textContent = laboratorio.nombre; // Asumiendo nombre en JSON
                laboratorioIdSelect.appendChild(option);
              });
            })
            .catch(err => console.error('Error al cargar laboratorios:', err));
  }

  // Cargar y mostrar la lista de TIPOS de Equipo
  function cargarTiposEquipo() {
    fetch(API_BASE_URL) // Llama a GET /equipos (ahora con FETCH JOIN para Cat/Lab)
            .then(res => res.json())
            .then(data => {
              equiposTbody.innerHTML = ''; // Limpiar la tabla de tipos
              data.forEach(equipo => {
                const row = document.createElement('tr');
                row.innerHTML = `
            <td>${equipo.idEquipo}</td>
            <td>${equipo.nombre}</td>
            <td>${equipo.categoria?.nombreCategoria || 'N/A'}</td> <td>${equipo.laboratorio?.nombre || 'N/A'}</td> <td>${equipo.descripcion}</td>
            <td>${equipo.estado}</td>
            <td>${equipo.cantidad}</td>
            <td>${equipo.marca}</td>
            <td>
              <button class="btn btn-sm btn-warning me-1 edit-type-btn" data-id="${equipo.idEquipo}">Editar Tipo</button>
              <button class="btn btn-sm btn-info view-instances-btn" data-id="${equipo.idEquipo}" data-nombre="${equipo.nombre}">Ver Instancias</button>
            </td>
          `;
                equiposTbody.appendChild(row);
              });
              attachEventListeners(); // Adjuntar event listeners a los botones (Editar Tipo, Ver Instancias)
            })
            .catch(err => console.error('Error al cargar tipos de equipos:', err));
  }

  // --- Funciones para Manejar Vistas ---

  // Muestra la sección de formulario/tabla de Tipos y oculta la de Instancias
  function mostrarVistaTipos() {
    tipoEquipoFormContainer.classList.remove('hidden');
    tiposEquipoTableContainer.classList.remove('hidden');
    instanciasSection.classList.add('hidden');
    // Removido: instanciaEditFormContainer.classList.add('hidden');
    resetFormularioTipo(); // Limpiar formulario de tipo al volver
  }

  // Muestra la sección de Instancias y oculta la de Tipos
  function mostrarVistaInstancias() {
    tipoEquipoFormContainer.classList.add('hidden');
    tiposEquipoTableContainer.classList.add('hidden');
    instanciasSection.classList.remove('hidden');
    // Removido: instanciaEditFormContainer.classList.add('hidden');
  }

  // --- Funciones para Cargar y Mostrar Instancias (SOLO LISTAR) ---

  // Cargar y mostrar las instancias individuales para un tipo de equipo específico
  function cargarInstanciasPorTipo(equipoId, tipoNombre) {
    currentTipoEquipoId = equipoId; // Guarda el ID del tipo actual
    currentInstanceTypeName.textContent = tipoNombre; // Actualiza el título
    instanciasSectionTitle.textContent = `Instancias Individuales (${tipoNombre})`; // Título de la sección

    // Llama a GET /equipos/{id}/instancias
    fetch(`${API_BASE_URL}/${equipoId}/instancias`)
            .then(res => {
              if (!res.ok) {
                throw new Error(`Error al cargar instancias: ${res.statusText}`);
              }
              return res.json();
            })
            .then(data => {
              instanciasTbody.innerHTML = ''; // Limpiar la tabla de instancias
              const numColumns = 5; // 5 columnas: ID, Código, Estado, Fecha, Notas
              if (data.length === 0) {
                instanciasTbody.innerHTML = `<tr><td colspan="${numColumns}" class="text-center">No hay instancias para este tipo de equipo.</td></tr>`;
              } else {
                data.forEach(instancia => {
                  const row = document.createElement('tr');
                  row.innerHTML = `
                  <td>${instancia.idInstancia}</td>
                  <td>${instancia.codigoActivo}</td>
                  <td>${instancia.estadoIndividual}</td>
                  <td>${instancia.fechaAdquisicion ? new Date(instancia.fechaAdquisicion).toLocaleDateString() : 'N/A'}</td>
                  <td>${instancia.notas || ''}</td>
                  `;
                  instanciasTbody.appendChild(row);
                });
                // REMOVED: attachEventListeners() // No hay botones de instancia que necesiten listeners
              }
              mostrarVistaInstancias(); // Mostrar la sección de instancias
            })
            .catch(err => {
              console.error('Error al cargar instancias:', err);
              instanciasTbody.innerHTML = `<tr><td colspan="${numColumns}" class="text-center text-danger">Error al cargar instancias: ${err.message}</td></tr>`;
              mostrarVistaInstancias();
            });
  }

  // REMOVED: Función cargarDatosInstanciaParaEdicion (no se editan instancias)
  // REMOVED: Función resetFormularioInstancia (no hay form de instancia)


  // --- Manejo de Formularios y Eventos ---

  // Adjuntar Event Listeners a botones (se llama después de cargar la tabla de tipos)
  function attachEventListeners() {
    // Listeners para botones "Editar Tipo" (en la tabla de tipos)
    document.querySelectorAll('.edit-type-btn').forEach(button => {
      button.removeEventListener('click', handleEditTypeClick); // Evitar duplicados
      button.addEventListener('click', handleEditTypeClick);
    });

    // Listeners para botones "Ver Instancias" (en la tabla de tipos)
    document.querySelectorAll('.view-instances-btn').forEach(button => {
      button.removeEventListener('click', handleViewInstancesClick); // Evitar duplicados
      button.addEventListener('click', handleViewInstancesClick);
    });

    // REMOVED: Listeners para botones "Editar Instancia" (no existen)
    // REMOVED: Listeners para el formulario de Instancia (no existe)
    // REMOVED: Listener para botón cancelar edición de instancia (no existe)
  }

  // Listener para el clic en el botón "Editar Tipo"
  function handleEditTypeClick(event) {
    const id = event.target.dataset.id;
    // Fetch los datos completos del tipo para llenar el formulario de edición
    fetch(`${API_BASE_URL}/${id}`) // Llama a GET /equipos/{id}
            .then(res => {
              if (!res.ok) {
                throw new Error(`Error al cargar tipo para edición: ${res.statusText}`);
              }
              return res.json();
            })
            .then(equipo => {
              // Llenar formulario con datos del tipo
              idEquipoInput.value = equipo.idEquipo;
              nombreInput.value = equipo.nombre;
              descripcionInput.value = equipo.descripcion;
              estadoInput.value = equipo.estado;
              cantidadInput.value = equipo.cantidad;
              marcaInput.value = equipo.marca;

              // Llenar selects para Categoría y Laboratorio
              // Asumimos que cargarCategorias y cargarLaboratorios ya se ejecutaron
              categoriaIdSelect.value = equipo.categoria?.idCategoria || '';
              laboratorioIdSelect.value = equipo.laboratorio?.idLaboratorio || '';

              // Cambiar texto del botón y mostrar cancelar si es edición
              equipoForm.querySelector('button[type="submit"]').textContent = 'Actualizar Tipo';
              cancelEditTypeBtn.classList.remove('hidden');
              tipoEquipoFormContainer.scrollIntoView({ behavior: 'smooth' }); // Desplazar a la vista del formulario
            })
            .catch(err => console.error('Error al cargar tipo para editar:', err));
  }

  // Listener para el clic en el botón "Ver Instancias"
  function handleViewInstancesClick(event) {
    const equipoId = event.target.dataset.id;
    const tipoNombre = event.target.dataset.nombre;
    cargarInstanciasPorTipo(equipoId, tipoNombre); // Carga y muestra las instancias para este tipo
  }


  // Enviar formulario de TIPO (guardar nuevo tipo/unidades o actualizar tipo)
  equipoForm.addEventListener('submit', function (e) {
    e.preventDefault();

    const idEquipo = idEquipoInput.value;
    const esEdicion = !!idEquipo;

    const equipoData = {
      nombre: nombreInput.value,
      descripcion: descripcionInput.value,
      // Enviar solo el objeto con el ID para ManyToOne
      categoria: { idCategoria: parseInt(categoriaIdSelect.value) },
      laboratorio: { idLaboratorio: parseInt(laboratorioIdSelect.value) },
      estado: estadoInput.value, // Usado para estado inicial de instancias al crear
      cantidad: parseInt(cantidadInput.value), // Usado al CREAR tipo
      marca: marcaInput.value
    };

    // Si estamos editando un tipo, no deberíamos enviar cantidad ni estado general
    if (esEdicion) {
      delete equipoData.cantidad;
      delete equipoData.estado;
    }

    const url = esEdicion
            ? `${API_BASE_URL}/${idEquipo}` // PUT para actualizar tipo
            : API_BASE_URL; // POST para crear nuevo tipo y unidades

    fetch(url, {
      method: esEdicion ? 'PUT' : 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(equipoData)
    })
            .then(res => {
              if (!res.ok) {
                // Manejar errores del API
                return res.json().then(error => Promise.reject(`Error del API: ${error.message || res.statusText}`));
              }
              return res.json(); // Asumimos que backend devuelve el objeto (creado o actualizado)
            })
            .then(() => {
              // Éxito al guardar/actualizar tipo (y crear instancias si fue POST)
              alert('Operación exitosa'); // Mensaje de éxito
              mostrarVistaTipos(); // Vuelve a la vista de tipos
              cargarTiposEquipo(); // Recarga la lista de tipos para ver los cambios
              resetFormularioTipo(); // Limpia el formulario de tipo
            })
            .catch(err => {
              console.error('Error al guardar/actualizar tipo de equipo:', err);
              alert(`Ocurrió un error: ${err}`); // Mostrar un mensaje de error al usuario
            });
  });


  // REMOVED: Listener para el formulario de INSTANCIA INDIVIDUAL (no existe)


  // --- Funciones de Reset ---

  // Limpiar el formulario de Tipo de Equipo
  function resetFormularioTipo() {
    equipoForm.reset();
    idEquipoInput.value = '';
    equipoForm.querySelector('button[type="submit"]').textContent = 'Guardar Tipo y Unidades';
    cancelEditTypeBtn.classList.add('hidden');
    // Resetear selects a la primera opción
    categoriaIdSelect.value = '';
    laboratorioIdSelect.value = '';
  }

  // REMOVED: Función para limpiar formulario de instancia (no existe)


  // --- Event Listeners Iniciales ---

  // Evento para el botón de cancelar edición de tipo
  cancelEditTypeBtn.addEventListener('click', resetFormularioTipo);

  // REMOVED: Evento para el botón de cancelar edición de instancia (no existe)

  // Evento para el botón "Volver a Tipos de Equipo"
  backToTypesBtn.addEventListener('click', mostrarVistaTipos);


  // Redirige a login.html después de cerrar sesión (si ese es el flujo)
  document.querySelector('.logout-btn').addEventListener('click', function (e) {
    e.preventDefault();
    // Implementar lógica real de logout en backend si es necesario
    window.location.href = '/login.html'; // Redirige al frontend
  });

  // --- Carga Inicial al Cargar la Página ---
  document.addEventListener('DOMContentLoaded', () => {
    cargarCategorias();
    cargarLaboratorios();
    cargarTiposEquipo();
    mostrarVistaTipos(); // Mostrar la vista de tipos por defecto
  });

  // Listener para el toggle del sidebar
  toggleSidebarBtn.addEventListener('click', () => {
    sidebar.classList.toggle('collapsed');
    content.classList.toggle('sidebar-collapsed');
  });

</script>
</body>
</html>

